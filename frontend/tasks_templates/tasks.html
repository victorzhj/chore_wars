<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>All Tasks</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .task-section { margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        h1 { text-align: center; color: #333; }
        h2 { border-bottom: 1px solid #ccc; padding-bottom: 5px; color: #555; }
        .task-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .task-card.completed { background-color: #e6ffe6; border-left: 5px solid #4CAF50; }
        .task-card h3 { margin-top: 0; color: #007bff; }
        .task-card p { margin: 5px 0; }
        .complete-btn {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            float: right;
        }
        .complete-btn:hover { background-color: #0056b3; }
        .nav-buttons { text-align: center; margin-bottom: 20px; }
        .nav-buttons button { margin: 0 10px; padding: 10px 20px; }
        .task-points { font-weight: bold; color: #ff9800; }
    </style>
</head>
<body>
    <div class="nav-buttons">
        <button onclick="window.location.href='/leaderboard'">Leaderboard</button>
        <button onclick="window.location.href='/tasks/add'">Add New Task</button>
        <form action="/user/logout" method="POST" style="display: inline-block;">
            <button type="submit" style="background-color: #f44336;">Logout</button>
        </form>
    </div>

    <h1>Task Management System</h1>
    
    <div class="task-section">
        <h2>ðŸ”¥ Open Tasks</h2>
        {% for task in open_tasks %}
            <div class="task-card" id="task-{{ task.task_id }}">
                <h3>{{ task.title }} 
                    <span class="task-points">({{ task.points }} Points)</span>
                </h3>
                <p><strong>Description:</strong> {{ task.description }}</p>
                <p><strong>Deadline:</strong> {{ task.deadline }}</p>
                <button 
                    class="complete-btn" 
                    data-task-id="{{ task.task_id }}" 
                    data-points="{{ task.points }}"
                    onclick="completeTask(this)">
                    Mark as Completed
                </button>
            </div>
        {% endfor %}
        {% if not open_tasks %}
            <p>No open tasks available. Time to create one!</p>
        {% endif %}
    </div>

    <div class="task-section">
        <h2>âœ… Closed Tasks</h2>
        {% for task in closed_tasks %}
            <div class="task-card completed">
                <h3>{{ task.title }} <span class="task-points">({{ task.points }} Points)</span></h3>
                <p><strong>Description:</strong> {{ task.description }}</p>
                <p><strong>Deadline:</strong> {{ task.deadline }}</p>
                <p style="color: #4CAF50; font-weight: bold;">Completed</p>
            </div>
        {% endfor %}
        {% if not closed_tasks %}
            <p>No closed tasks yet.</p>
        {% endif %}
    </div>

    <script>
        // Function to handle task completion
        async function completeTask(buttonElement) {
            const taskId = buttonElement.getAttribute('data-task-id');
            const points = parseInt(buttonElement.getAttribute('data-points'));
            
            // 1. Update the task status to completed (using /tasks/modify)
            const taskData = {
                task_id: taskId,
                title: document.querySelector(`#task-${taskId} h3`).textContent.split('(')[0].trim(), // Simple way to grab existing title
                description: document.querySelector(`#task-${taskId} p:nth-child(2)`).textContent.replace('Description: ', ''), // Grab existing description
                points: points,
                deadline: new Date().toISOString().slice(0, 16), // Use current date/time in 'YYYY-MM-DDThh:mm' format
                completed: true
            };

            try {
                const modifyResponse = await fetch('/tasks/modify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });

                if (!modifyResponse.ok) {
                    throw new Error('Failed to modify task status');
                }
                
                // 2. Update the user's points (using /user/points)
                const pointsData = { points: points };

                const pointsResponse = await fetch('/user/points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pointsData)
                });
                
                if (pointsResponse.ok) {
                    // Success: Task updated and points added. The /user/points route redirects to the leaderboard on success.
                    // For a seamless experience, we should probably reload the current tasks page instead of blindly following the redirect.
                    alert('Task completed and points added! Redirecting to Tasks page...');
                    window.location.reload(); 
                } else {
                    throw new Error('Failed to update user points');
                }

            } catch (error) {
                console.error('Error completing task:', error);
                alert('An error occurred while completing the task. Please check the console.');
            }
        }
    </script>
</body>
</html>